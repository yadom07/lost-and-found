<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Post - ModFinder+</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/layout.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root { --control-h: 46px; }

    .post-form-page .form-grid { display: grid; gap: var(--s-5); }
    .post-form-page .field { display: grid; gap: var(--s-2); }

    .post-form-page .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--s-4);
      align-items: start;
    }
    @media (max-width: 720px) { .post-form-page .grid-2 { grid-template-columns: 1fr; } }

    .post-form-page input[type="text"],
    .post-form-page input[type="email"],
    .post-form-page input[type="file"],
    .post-form-page select,
    .post-form-page textarea {
      height: var(--control-h);
      min-height: var(--control-h);
      padding: 0.78rem 0.9rem;
      font-weight: 900;
    }

    .post-form-page textarea {
      height: var(--control-h);
      min-height: var(--control-h);
      resize: vertical;
    }

    .post-form-page select {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--text-muted) 50%),
        linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
      background-size: 6px 6px;
      background-repeat: no-repeat;
      padding-right: 2.25rem;
    }

    .post-form-page input[type="file"] { padding: 0.65rem 0.9rem; }

    .post-form-page .secondary-button,
    .post-form-page .primary-button {
      height: var(--control-h);
      min-height: var(--control-h);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .post-form-page .full-width { width: 100%; }
    .post-form-page .map-wrap { margin-top: var(--s-3); }
    .post-form-page #map { width: 100%; height: 320px; }

    .post-form-page .sub-actions {
      margin-top: var(--s-2);
      display: flex;
      gap: var(--s-2);
      flex-wrap: wrap;
    }

    .post-form-page .hint {
      font-size: 0.85rem;
      font-weight: 900;
      color: var(--text-muted);
      margin-top: var(--s-1);
    }

    .post-form-page .readonly {
      opacity: 0.92;
      cursor: not-allowed;
      background: var(--surface);
    }

    .post-form-page .invalid {
      border-color: var(--lost);
      box-shadow: 0 0 0 4px var(--ring-lost);
    }

    .post-form-page .field-error {
      display: none;
      margin-top: var(--s-2);
      font-size: 0.85rem;
      font-weight: 900;
      color: var(--lost);
    }
    .post-form-page .field-error:not(:empty) { display: block; }

    .contact-value-wrap { display: none; }
    .contact-value-wrap.show { display: block; }

    .form-section {
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--r-md);
      padding: var(--s-4);
      box-shadow: var(--shadow-1);
      display: grid;
      gap: var(--s-4);
    }
    .form-section-title {
      font-weight: 950;
      font-size: 0.95rem;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--s-2);
    }
    .form-section-title .muted {
      font-weight: 900;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
  </style>
</head>

<body class="post-form-page">

  <header class="topbar">
    <div class="topbar-left">
      <button class="icon-button" aria-label="Menu">â‰¡</button>

      <a class="brand-link" href="index.html" aria-label="ModFinder+ Home">
        <img
          class="brand-logo"
          src="https://img5.pic.in.th/file/secure-sv1/CPE101_I16_LOST__FOUND.png"
          alt="ModFinder+"
        />
      </a>
    </div>

    <div class="topbar-actions">
      <a class="primary-button" href="post-form.html">Post</a>

      <div class="user-menu">
        <button class="user-button" id="userBtn" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar">ðŸ‘¤</span>
          <span class="user-name" id="userNameTop">User</span>
        </button>

        <div class="user-dropdown" id="userMenu" role="menu">
          <button class="user-item" type="button" data-action="profile">Profile</button>
          <button class="user-item" type="button" data-action="my-posts">My Posts</button>
          <hr />
          <button class="user-item danger" type="button" data-action="logout">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="page">
    <section class="card pad">
      <h2 class="section-title">Post information</h2>

      <form id="postForm" class="form-grid" novalidate>

        <input type="text" id="posterName" class="readonly" style="display:none;" readonly />
        <div class="field-error" id="posterNameError" aria-live="polite" style="display:none;"></div>

        <div class="form-section">
          <div class="form-section-title">
            <span>Item details</span>
            <span class="muted"></span>
          </div>

          <div class="field">
            <label for="title">Title</label>
            <input type="text" id="title" required placeholder="e.g. Black wallet" />
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="type">Type</label>
              <select id="type" required>
                <option value="" selected disabled>type</option>
                <option value="lost">Lost</option>
                <option value="found">Found</option>
              </select>
            </div>

            <div class="field">
              <label for="image">Upload Image (optional)</label>
              <input type="file" id="image" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">
            <span>Contact</span>
            <span class="muted"></span>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="contactMethod">Contact method</label>
              <select id="contactMethod" required>
                <option value="" selected disabled>Select contact method</option>
                <option value="facebook">Facebook</option>
                <option value="instagram">Instagram</option>
                <option value="line">LINE</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
              </select>
              <div class="field-error" id="contactMethodError" aria-live="polite"></div>
            </div>

            <div class="field contact-value-wrap" id="contactValueWrap">
              <label for="contactValue" id="contactValueLabel">Contact</label>
              <input
                type="text"
                id="contactValue"
                class="readonly"
                readonly
                placeholder=""
                required
              />
              <div class="field-error" id="contactValueError" aria-live="polite"></div>
              <div class="hint">This value is taken from your registered profile.</div>
            </div>
          </div>

          <div class="field">
            <label for="description">Description</label>
            <textarea id="description" required placeholder="More details e.g. color / brand / where it was lost"></textarea>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">
            <span>Location</span>
            <span class="muted"></span>
          </div>

          <div class="field">
            <label for="location">Coordinates</label>
            <input type="text" id="location" placeholder="Click on the map" required />
            <div class="hint">Tip: Click on the map to set a pin, or use your current location.</div>

            <div class="sub-actions">
              <button type="button" id="useCurrentLocation" class="secondary-button">
                Use my current location
              </button>
              <button type="button" id="clearPin" class="secondary-button">
                Clear pin
              </button>
            </div>

            <div class="map-wrap">
              <div id="map"></div>
            </div>
          </div>
        </div>

        <button type="submit" class="primary-button full-width">Submit</button>
      </form>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const DEFAULT_LAT = 13.650823117723881;
    const DEFAULT_LNG = 100.49388527870178;

    let map;
    let marker;

    function setMarker(lat, lng) {
      if (!map) return;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);

      const locEl = document.getElementById("location");
      if (locEl) locEl.value = `${lat}, ${lng}`;
    }

    function clearMarker() {
      if (marker && map) { map.removeLayer(marker); marker = null; }
      const locEl = document.getElementById("location");
      if (locEl) locEl.value = "";
      if (map) map.setView([DEFAULT_LAT, DEFAULT_LNG], 16);
    }

    function initMap() {
      const mapEl = document.getElementById("map");
      if (!mapEl || typeof L === "undefined") return;

      map = L.map(mapEl).setView([DEFAULT_LAT, DEFAULT_LNG], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap"
      }).addTo(map);

      setTimeout(() => map.invalidateSize(), 200);
      map.on("click", (e) => setMarker(e.latlng.lat, e.latlng.lng));
    }

    function wireCurrentLocation() {
      const btn = document.getElementById("useCurrentLocation");
      if (!btn) return;

      btn.addEventListener("click", () => {
        // âœ… geolocation à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ https / localhost (file:// à¸ˆà¸°à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™)
        if (window.location.protocol === "file:") {
          alert("Geolocation does not work on file://.\nPlease run with Live Server or deploy on HTTPS.");
          return;
        }

        if (!navigator.geolocation) {
          alert("Your browser does not support geolocation.");
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = "Getting location...";

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            setMarker(lat, lng);
            if (map) map.setView([lat, lng], 17);

            btn.disabled = false;
            btn.textContent = oldText;
          },
          (err) => {
            console.error(err);

            let msg = "Unable to get your current location.";
            if (err && typeof err.code === "number") {
              if (err.code === 1) msg = "Permission denied for location.";
              if (err.code === 2) msg = "Position unavailable.";
              if (err.code === 3) msg = "Location request timed out.";
            }
            alert(msg);

            btn.disabled = false;
            btn.textContent = oldText;
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
        );
      });
    }

    function wireClearPin() {
      const btn = document.getElementById("clearPin");
      if (!btn) return;
      btn.addEventListener("click", () => clearMarker());
    }

    window.addEventListener("load", () => {
      initMap();
      wireCurrentLocation();
      wireClearPin();
    });
  </script>

  <script type="module" src="js/auth-guard.js"></script>
  <script type="module" src="js/ui.js"></script>
  <script type="module" src="js/post-form.js"></script>
</body>
</html>