<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Post - Campus Lost & Found</title>

  <!-- Global styles -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/layout.css" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
</head>

<body>
  <!-- ================= Topbar ================= -->
  <header class="topbar">
    <div class="topbar-left">
      <button class="icon-button" onclick="history.back()" aria-label="Back">‚Üê</button>
      <div class="topbar-title">Create Post</div>
    </div>

    <div class="topbar-actions">
      <a class="secondary-button" href="index.html">Home</a>

      <div class="user-menu">
        <button class="user-button" id="userBtn" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar">üë§</span>
          <span class="user-name" id="userName">User</span>
        </button>

        <div class="user-dropdown" id="userMenu" role="menu">
          <button class="user-item" type="button">Profile</button>
          <button class="user-item" type="button">My Posts</button>
          <hr />
          <button class="user-item danger" type="button">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ================= Page ================= -->
  <main class="page">
    <section class="card pad">
      <h2 class="section-title">Post information</h2>

      <form id="postForm" style="display:grid; gap: var(--s-4);">
        <!-- Title -->
        <div>
          <label for="title">Title</label>
          <input
            type="text"
            id="title"
            required
            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå‡∏™‡∏µ‡∏î‡∏≥"
          />
        </div>

        <!-- Type + Image -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--s-4);">
          <div>
            <label for="type">Type</label>
            <select id="type" required>
              <option value="lost">Lost</option>
              <option value="found">Found</option>
            </select>
          </div>

          <div>
            <label for="image">Upload Image (optional)</label>
            <input type="file" id="image" accept="image/*" />
          </div>
        </div>

        <!-- Location + Map -->
        <div>
          <label for="location">Location</label>
          <input
            type="text"
            id="location"
            placeholder="Click on the map"
            required
          />

          <div style="margin-top: var(--s-2);">
            <button
              type="button"
              id="useCurrentLocation"
              class="secondary-button"
            >
              ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            </button>
          </div>

          <div class="map-wrap" style="margin-top: var(--s-3);">
            <div id="map"></div>
          </div>
        </div>

        <!-- Description -->
        <div>
          <label for="description">Description</label>
          <textarea
            id="description"
            required
            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ / ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢"
          ></textarea>
        </div>

        <!-- Submit -->
        <button type="submit" class="primary-button full-width">
          Submit
        </button>
      </form>
    </section>
  </main>

  <!-- ================= Scripts ================= -->

  <!-- User menu -->
  <script>
    const userBtn = document.getElementById("userBtn");
    const userMenu = document.getElementById("userMenu");

    if (userBtn && userMenu) {
      userBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const open = userMenu.classList.toggle("open");
        userBtn.setAttribute("aria-expanded", String(open));
      });

      document.addEventListener("click", () => {
        userMenu.classList.remove("open");
        userBtn.setAttribute("aria-expanded", "false");
      });
    }
  </script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Map logic (FIXED) -->
  <script>
    const DEFAULT_LAT = 13.650823117723881;
    const DEFAULT_LNG = 100.49388527870178;

    let map;
    let marker;

    function initMap() {
      const mapEl = document.getElementById("map");
      if (!mapEl) return;

      map = L.map(mapEl).setView([DEFAULT_LAT, DEFAULT_LNG], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap"
      }).addTo(map);

      // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ leaflet ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
      setTimeout(() => {
        map.invalidateSize();
      }, 200);

      map.on("click", (e) => {
        setMarker(e.latlng.lat, e.latlng.lng);
      });
    }

    function setMarker(lat, lng) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById("location").value = `${lat}, ${lng}`;
    }

    document
      .getElementById("useCurrentLocation")
      .addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            setMarker(lat, lng);
            map.setView([lat, lng], 17);
          },
          () => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ")
        );
      });

    // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM + layout ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô
    window.addEventListener("load", initMap);
  </script>

  <!-- Firebase / submit logic -->
  <script type="module" src="js/post-form.js"></script>
</body>
</html>